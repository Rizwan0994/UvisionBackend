name: Generate and Deploy API Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/routes/**'
      - 'src/controllers/**'
      - 'src/models/**'
      - 'src/config/swagger.js'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/routes/**'
      - 'src/controllers/**'
      - 'src/models/**'
      - 'src/config/swagger.js'

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Validate OpenAPI specification
      run: npm run docs:validate
      
    - name: Generate documentation
      run: npm run docs:generate
      
    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: api-documentation
        path: docs/
        retention-days: 30
        
    - name: Deploy to GitHub Pages (on main branch)
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        destination_dir: api-docs
        
    - name: Comment PR with documentation links
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const pr_number = context.issue.number;
          
          const comment = `## 📚 API Documentation Updated
          
          The API documentation has been regenerated based on your changes.
          
          ### Preview Links:
          - 🌐 **Swagger UI**: [View Interactive Docs](https://${owner}.github.io/${repo}/api-docs/)
          - 📘 **ReDoc**: [View Alternative Docs](https://${owner}.github.io/${repo}/api-docs/redoc.html)
          - 📄 **OpenAPI Spec**: [Download JSON](https://${owner}.github.io/${repo}/api-docs/openapi.json)
          - 📋 **Postman Collection**: [Download Collection](https://${owner}.github.io/${repo}/api-docs/postman-collection.json)
          
          ### Changes Detected:
          - Routes: \`${{ github.event.pull_request.changed_files }}\`
          
          Documentation will be automatically deployed when this PR is merged to main.`;
          
          github.rest.issues.createComment({
            owner: owner,
            repo: repo,
            issue_number: pr_number,
            body: comment
          });

  validate-api-changes:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate current API spec
      run: |
        npm run docs:generate
        cp docs/openapi.json current-spec.json
        
    - name: Checkout main branch
      run: git checkout main
      
    - name: Generate main branch API spec
      run: |
        npm ci
        npm run docs:generate
        cp docs/openapi.json main-spec.json
        
    - name: Compare API specifications
      run: |
        echo "## API Changes Detection" >> $GITHUB_STEP_SUMMARY
        
        if ! cmp -s current-spec.json main-spec.json; then
          echo "✅ API specification changes detected" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Endpoints:" >> $GITHUB_STEP_SUMMARY
          
          # You can add more sophisticated diff analysis here
          echo "- API specification has been modified" >> $GITHUB_STEP_SUMMARY
          echo "- Please review the changes in the generated documentation" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No API specification changes detected" >> $GITHUB_STEP_SUMMARY
        fi
